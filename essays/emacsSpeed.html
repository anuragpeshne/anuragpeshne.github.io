<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="viewport" content="width=device-width, initial-scale=1" />
<title>Speeding Up Emacs</title>
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Anurag Peshne" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../css/style.css" />
<link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<link rel="canonical" href="https://anuragpeshne.github.io/essays/emacsSpeed.html" />
</head>
<body>
<div id="content">
<h1 class="title">Speeding Up Emacs</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgheadline1">1. Motivation</a></li>
<li><a href="#orgheadline6">2. Attempts</a>
<ul>
<li><a href="#orgheadline3">2.1. Garbage Collection Threshold (<code>gc-cons-threshold</code>)</a>
<ul>
<li><a href="#orgheadline2">2.1.1. GC Caveats</a></li>
</ul>
</li>
<li><a href="#orgheadline4">2.2. <code>use-package</code></a></li>
<li><a href="#orgheadline5">2.3. <span class="todo TODO">TODO</span> <code>emacs --daemon</code></a></li>
</ul>
</li>
<li><a href="#orgheadline9">3. Conclusion</a>
<ul>
<li><a href="#orgheadline7">3.1. Macbook Pro (Late 2013 Model) SSD with 8GB Memory</a></li>
<li><a href="#orgheadline8">3.2. Macbook Pro (Mid 2012 Model) HDD with 10GB Memory</a></li>
</ul>
</li>
</ul>
</div>
</div>
<script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-67524931-1', 'auto'); ga('send', 'pageview'); </script>
<div id="draftTag">DRAFT</div>

<div id="outline-container-orgheadline1" class="outline-2">
<h2 id="orgheadline1"><span class="section-number-2">1</span> Motivation</h2>
<div class="outline-text-2" id="text-1">
<p>
I've being using Emacs for quite some time now. After picking up several modes and
packages on the way, my <code>init.el</code> grew linearly with the time spent. And so did
my Emacs' startup time. It clocked at around 5 seconds on my SSD equipped Mac and
crawled on the Mac at work, having rotating hard drive, taking whooping
<b>9.1 seconds</b>.
</p>

<div class="figure">
<p><img src="../assets/emacsSpeed/initTime.png" alt="initTime.png" />
</p>
<p><span class="figure-number">Figure 1:</span> result of <code>(emacs-init-time)</code>. Not a very pleasing way to start your day.</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline6" class="outline-2">
<h2 id="orgheadline6"><span class="section-number-2">2</span> Attempts</h2>
<div class="outline-text-2" id="text-2">
<p>
I found several solutions to speed up Emacs start on the web. Since I'm fairly
satisfied with the performance once Emacs starts up, I'm interested only in
improving startup time. To benchmark that, I'm using inbuilt function <code>emacs-init-time</code>
</p>

<div class="org-src-container">

<pre class="src src-lisp">emacs-init-time is an interactive autoloaded compiled Lisp function in `<span style="color: #BFEBBF;">time.el</span>'.

(emacs-init-time)

Return a string giving the duration of the Emacs initialization.
</pre>
</div>

<p>
Since memory is cached once we load up an application, subsequent attempts to
benchmark loading time gives inaccurate results. To get around that, I'm using
<code>purge</code> call to flush cached memory.
</p>
</div>
<div id="outline-container-orgheadline3" class="outline-3">
<h3 id="orgheadline3"><span class="section-number-3">2.1</span> Garbage Collection Threshold (<code>gc-cons-threshold</code>)</h3>
<div class="outline-text-3" id="text-2-1">
<p>
I found <a href="https://www.reddit.com/r/emacs/comments/3kqt6e/2_easy_little_known_steps_to_speed_up_emacs_start/">this reddit thread</a> which claims to speedup by increasing the threshold
of the bytes consumed before garbage collector is invoked.
</p>

<div class="org-src-container">

<pre class="src src-lisp">gc-cons-threshold is a variable defined in `C source code'.
Its value is 800000

Documentation:
Number of bytes of consing between garbage collections.
Garbage collection can happen automatically once this many bytes have been
allocated since the last garbage collection.  All data types count.

Garbage collection happens automatically only when `<span style="color: #BFEBBF;">eval</span>' is called.

By binding this temporarily to a large number, you can effectively
prevent garbage collection during a part of the program.
See also `<span style="color: #BFEBBF;">gc-cons-percentage</span>'.
</pre>
</div>

<p>
I bumped up the value to 10<sup>8</sup>, purged the memory and fired up Emacs and got
<b>8.7 seconds</b>. This was just few milliseconds less than original value (<i>9.1
seconds</i>). This is not very impressive, further I'm not sure how much of this
improvement can be attributed to gc tweak and how much to cached memory (I'm
not sure which all files are purged).
</p>
</div>

<div id="outline-container-orgheadline2" class="outline-4">
<h4 id="orgheadline2"><span class="section-number-4">2.1.1</span> GC Caveats</h4>
<div class="outline-text-4" id="text-2-1-1">
<p>
As noted by <i>RobThorpe</i> on the same thread,
</p>
<p class="verse">
Be aware that the GC pause gets longer as you raise the cons-threshold.<br  />
If you raise it a lot it may become irritatingly long and you'll begin to notice it while editing.<br  />
</p>

<p>
Is it okay to play around with this value without knowing what it does for sure?
Is it possible that I'm loading far too many modules which is hitting the threshold
and consequently taking more time to clean up. I don't know, maybe I can visit
this solution again after implementing <code>use-package</code>.
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline4" class="outline-3">
<h3 id="orgheadline4"><span class="section-number-3">2.2</span> <code>use-package</code><sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup></h3>
<div class="outline-text-3" id="text-2-2">
<p>
There are two main motivation for me to try <code>use-package</code>:
</p>
<ol class="org-ol">
<li>It cleans up <code>init.el</code>: it groups configuration for each mode into blocks.</li>
<li>It gives option to delay package's loading until it is needed.</li>
</ol>

<p>
After following <code>use-package</code> <a href="https://github.com/jwiegley/use-package">documentation</a> and Sacha Chua's <a href="http://pages.sachachua.com/.emacs.d/Sacha.html">dotemacs</a>, I restructured
my <a href="https://github.com/anuragpeshne/dot_files/blob/master/.emacs.d/init.el"><code>init.el</code></a>. If you are new to <code>use-package</code>, here's a quick crash course:
</p>

<ul class="org-ul">
<li>Instead of 'requiring' package, you declare it as <code>(use-package foo)</code>.</li>
<li>You can toggle several switches which affects how the package is loaded:
<ul class="org-ul">
<li><code>:init</code> execute code before package is loaded.</li>
<li><code>:config</code> execute code after package is loaded.</li>
<li><code>:bind</code> bind keystrokes to function.</li>
<li><code>:command</code> creates autoload for those commands.</li>
<li><code>:ensure</code> installs package if not found on system. Great way to setup environment.</li>
<li><code>:defer</code> defers loading of the package until needed. You can pass integer
which loads the package after N seconds of idle time. Eg: <code>:defer 4</code>.</li>
<li>and many more. Read about them here <a href="https://github.com/jwiegley/use-package/blob/master/README.md">README</a>.</li>
</ul></li>
</ul>

<p>
After refactoring my <code>init.el</code> for couple of hours, I could defer loading of
most of the packages (with the exception being 'evil' mode and 'zenburn' theme).
My startup time reduced to <b>3.5 seconds</b> and <b>2.1 seconds</b> on Mac with SSD :D
</p>

<div class="figure">
<p><img src="../assets/emacsSpeed/initTimeUsePackage.png" alt="initTimeUsePackage.png" />
</p>
<p><span class="figure-number">Figure 2:</span> <code>(emacs-init-time)</code> after using <code>use-package</code> module.</p>
</div>

<p>
Here's a snippet from my <code>init.el</code>:
</p>
<div class="org-src-container">

<pre class="src src-lisp">(use-package evil
             <span style="color: #DCDCCC; font-weight: bold;">:ensure</span> t
             <span style="color: #DCDCCC; font-weight: bold;">:demand</span>
             <span style="color: #DCDCCC; font-weight: bold;">:init</span>
             (<span style="color: #F0DFAF; font-weight: bold;">progn</span>
               (setq evil-want-C-u-scroll t)
               <span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">Change cursor color depending on mode</span>
               (setq evil-emacs-state-cursor '(<span style="color: #CC9393;">"red"</span> box)
                     evil-normal-state-cursor '(<span style="color: #CC9393;">"green"</span> box)
                     evil-visual-state-cursor '(<span style="color: #CC9393;">"orange"</span> box)
                     evil-insert-state-cursor '(<span style="color: #CC9393;">"red"</span> bar)
                     evil-replace-state-cursor '(<span style="color: #CC9393;">"red"</span> bar)
                     evil-operator-state-cursor '(<span style="color: #CC9393;">"red"</span> hollow))
               (evil-mode 1)))

(use-package magit <span style="color: #DCDCCC; font-weight: bold;">:ensure</span> t <span style="color: #DCDCCC; font-weight: bold;">:defer</span> 5)

<span style="color: #5F7F5F;">;; </span><span style="color: #7F9F7F;">highlight changes</span>
(use-package git-gutter-fringe
  <span style="color: #DCDCCC; font-weight: bold;">:ensure</span> t
  <span style="color: #DCDCCC; font-weight: bold;">:diminish</span> git-gutter-mode
  <span style="color: #DCDCCC; font-weight: bold;">:config</span> (global-git-gutter-mode))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgheadline5" class="outline-3">
<h3 id="orgheadline5"><span class="section-number-3">2.3</span> <span class="todo TODO">TODO</span> <code>emacs --daemon</code></h3>
<div class="outline-text-3" id="text-2-3">
</div>
</div>
</div>

<div id="outline-container-orgheadline9" class="outline-2">
<h2 id="orgheadline9"><span class="section-number-2">3</span> Conclusion</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-orgheadline7" class="outline-3">
<h3 id="orgheadline7"><span class="section-number-3">3.1</span> Macbook Pro (Late 2013 Model) SSD with 8GB Memory</h3>
<div class="outline-text-3" id="text-3-1">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Tweak</th>
<th scope="col" class="org-right"><code>(emacs-init-time)</code> (sec)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">No Tweak</td>
<td class="org-right">4.8</td>
</tr>

<tr>
<td class="org-left"><code>gc-cons-threshold</code></td>
<td class="org-right">3.7</td>
</tr>

<tr>
<td class="org-left"><code>use-package</code></td>
<td class="org-right">2.1</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgheadline8" class="outline-3">
<h3 id="orgheadline8"><span class="section-number-3">3.2</span> Macbook Pro (Mid 2012 Model) HDD with 10GB Memory</h3>
<div class="outline-text-3" id="text-3-2">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-right" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Tweak</th>
<th scope="col" class="org-right"><code>(emacs-init-time)</code> (sec)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">No Tweak</td>
<td class="org-right">9.1</td>
</tr>

<tr>
<td class="org-left"><code>gc-cons-threshold</code></td>
<td class="org-right">8.7</td>
</tr>

<tr>
<td class="org-left"><code>use-package</code></td>
<td class="org-right">6.7</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
: <a href="https://github.com/jwiegley/use-package">jwiegley/use-package</a>
</p></div></div>


</div>
</div><div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
this.page.url = "https://anuragpeshne.github.io/essays/emacsSpeed.html";
this.page.identifier = "/essays/emacsSpeed.html";
};
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//anuragpeshne.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div>
<div id="postamble" class="status">
<p class="date">Date: 2016-03-19</p>
<p class="author">Author: Anurag Peshne</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.5.1 (<a href="http://orgmode.org">Org</a> mode 8.3.4)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
